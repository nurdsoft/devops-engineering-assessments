name: "Terraform Workflow"

on:
  pull_request_target:
    types:
      - opened
      - synchronize
  workflow_dispatch:

jobs:
  terraform:
    name: "Terraform Validation"
    runs-on: ubuntu-latest
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: ${{ secrets.AWS_REGION }}

    steps:
      # 1. Checkout Code
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.pull_request.head.ref }}

      # 2. Determine Assignment Directories
      - name: Determine Assignment Directories
        id: assignment-dirs
        run: |
          EC2_INSTANCE_DIR=devops-engineering-assessments/assignments/public-cloud/aws/compute/ec2-instance/
          SITE2SITE_VPN_DIR=devops-engineering-assessments/assignments/public-cloud/aws/networking/site2site-vpn/

          # Validate ec2-instance directory
          if [ -z "$EC2_INSTANCE_DIR" ] || [ ! -d "$EC2_INSTANCE_DIR" ]; then
            echo "Error: EC2 instance directory not found."
            exit 1
          fi
          echo "EC2_INSTANCE_DIR=${EC2_INSTANCE_DIR}" >> $GITHUB_ENV
          echo "EC2 instance directory: $EC2_INSTANCE_DIR"

          # Validate site2site-vpn directory
          if [ -z "$SITE2SITE_VPN_DIR" ] || [ ! -d "$SITE2SITE_VPN_DIR" ]; then
            echo "Error: Site-to-Site VPN directory not found."
            exit 1
          fi
          echo "SITE2SITE_VPN_DIR=${SITE2SITE_VPN_DIR}" >> $GITHUB_ENV
          echo "Site-to-Site VPN directory: $SITE2SITE_VPN_DIR"

      # 3. Process EC2 Instance Directory
      - name: Process EC2 Instance Directory
        working-directory: devops-engineering-assessments/assignments/public-cloud/aws/compute/ec2-instance/
        run: |
          terraform init
          terraform validate
          terraform plan

      # 4. Process Site-to-Site VPN Directory
      - name: Process Site-to-Site VPN Directory
        working-directory: devops-engineering-assessments/assignments/public-cloud/aws/networking/site2site-vpn/
        run: |
          terraform init
          terraform validate
          terraform plan
